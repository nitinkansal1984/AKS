OSM automatically discovers services that are a part of the service mesh.
OSM creates traffic policy rules on each Envoy proxy sidecar to be able to communicate with these services.


## Create resource group
az group create --name myResourceGroup --location eastus

## Create AKS cluster with open-service-mesh enabled

az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --enable-addons open-service-mesh \
  --node-count 2

## Get the credentials for your cluster
az aks get-credentials --resource-group myResourceGroup --name myAKSCluster --overwrite

##Verify that the OSM add-on is installed on your cluster

az aks show --resource-group myResourceGroup --name myAKSCluster  --query 'addonProfiles.openServiceMesh.enabled'

## Verify that the OSM mesh is running on your cluster

kubectl get pods -n kube-system

## You will see bootstrap, controller and injector running

## Verify the configuration of your OSM mesh

kubectl get meshconfig osm-mesh-config -n kube-system -o yaml

Here enablePermissiveTrafficPolicyMode: true, which means OSM has permissive traffic policy mode enabled. With this mode enabled in your OSM mesh:

The SMI - Service Mesh Interface traffic policy enforcement is bypassed.

Service Mesh Interface is a specification that covers the most common service mesh capabilities:

Traffic policy – apply policies like identity and transport encryption across services
Traffic telemetry – capture key metrics like error rate and latency between services
Traffic management – shift traffic between different services




## Instal osm client

OSM_VERSION=v1.0.0
curl -sL "https://github.com/openservicemesh/osm/releases/download/$OSM_VERSION/osm-$OSM_VERSION-linux-amd64.tar.gz" | tar -vxzf -
echo "export PATH=$PATH:/home/nitin/linux-amd64/" >> ~/.profile

## Check the version of open service mesh
osm version


## Let's now deploy sample microservice. We will deploy 5 different Pods as part of this microservice, and we will apply policies to control the traffic between them.
## Let's first create 5 name namespaces for each component of the service

kubectl create ns bookstore 
kubectl create ns bookbuyer 
kubectl create ns bookthief 
kubectl create ns bookwarehouse

## Verify the namespace
kubectl get ns bookstore -o yaml

## Enable OSM to the namespaces

osm namespace add bookstore bookbuyer bookthief bookwarehouse

## osm controller will keep on monitoring any pods being created in these namespace and will add envoy sidecar proxy to that. 
## The above command will add annotation which we can verify by running command:

kubectl get ns bookstore -o yaml

NOTE: Each namespace will have 2 annotations
openservicemesh.io/monitored-by: osm 
openservicemesh.io/sidecar-injection: enabled

## 

## Let's now onboard the application:
## First create a directory /tmp/bookapp and download all required yaml files there:
mkdir /tmp/bookapp
cd /tmp/bookapp
curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/bookbuyer.yaml -o /tmp/bookapp/bookbuyer.yaml 
curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/bookwarehouse.yaml -o /tmp/bookapp/bookwarehouse.yaml
curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/mysql.yaml -o /tmp/bookapp/mysql.yaml
curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/bookstore-v1.yaml -o /tmp/bookapp/bookstore-v1.yaml
curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/bookstore-v2.yaml -o /tmp/bookapp/bookstore-v2.yaml
curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/bookthief.yaml -o /tmp/bookapp/bookthief.yaml

kubectl apply -f .

## Download the script and execute to portforward the pods to access from browser:

curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/port-forward-all.sh -o /tmp/bookapp/port-forward-all.sh
chmod +x /tmp/bookapp/port-forward-all.sh

BOOKBUYER_LOCAL_PORT=7070 BOOKSTOREv1_LOCAL_PORT=7071 BOOKSTOREv2_LOCAL_PORT=7072 BOOKTHIEF_LOCAL_PORT=7073 BOOKSTORE_LOCAL_PORT=7074 /tmp/bookapp/port-forward-all.sh



## Now let's split the traffic:

curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/traffic-split-50-50.yaml -o /tmp/bookapp/traffic-split-50-50.yaml 
curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/traffic-split-v1.yaml -o /tmp/bookapp/traffic-split-v1.yaml
curl https://raw.githubusercontent.com/nitinkansal1984/AKS/main/traffic-split-v2.yaml -o /tmp/bookapp/traffic-split-v2.yaml

## Deploy application 

kubectl apply -f /tmp/bookapp/

What got installed?
kubectl get pods,deployments,serviceaccounts -n bookbuyer
kubectl get pods,deployments,serviceaccounts -n bookthief

kubectl get pods,deployments,serviceaccounts,services,endpoints -n bookstore
kubectl get pods,deployments,serviceaccounts,services,endpoints -n bookwarehouse


curl https://raw.githubusercontent.com/openservicemesh/osm/main/.env.example -o /tmp/bookapp/.env.example
